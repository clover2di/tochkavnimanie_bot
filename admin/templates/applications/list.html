{% extends "base.html" %}

{% block title %}–ó–∞—è–≤–∫–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}
{% block page_title %}–ó–∞—è–≤–∫–∏{% endblock %}

{% block content %}
<!-- Filters -->
<div class="table-card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end" id="filterForm">
            <!-- Search -->
            <div class="col-md-4">
                <label class="form-label">–ü–æ–∏—Å–∫ (–§–ò–û, —à–∫–æ–ª–∞)</label>
                <input type="text" name="search" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..." 
                       value="{{ current_search }}">
            </div>
            
            <!-- Nomination -->
            <div class="col-md-2">
                <label class="form-label">–≠—Ç–∞–ø</label>
                <select name="nomination_id" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for nom in nominations %}
                    <option value="{{ nom.id }}" {% if current_nomination == nom.id %}selected{% endif %}>{{ nom.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- City -->
            <div class="col-md-2">
                <label class="form-label">–ì–æ—Ä–æ–¥</label>
                <select name="city" class="form-select">
                    <option value="">–í—Å–µ</option>
                    {% for c in cities %}
                    <option value="{{ c }}" {% if current_city == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Date range -->
            <div class="col-md-2">
                <label class="form-label">–° –¥–∞—Ç—ã</label>
                <input type="date" name="date_from" class="form-control" value="{{ current_date_from }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">–ü–æ –¥–∞—Ç—É</label>
                <input type="date" name="date_to" class="form-control" value="{{ current_date_to }}">
            </div>
            
            <!-- Buttons -->
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> –ù–∞–π—Ç–∏
                </button>
                <a href="/applications" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Applications Table -->
<div class="table-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">–ù–∞–π–¥–µ–Ω–æ: {{ total }}</h5>
        <a href="/applications/export/xlsx?nomination_id={{ current_nomination or '' }}&search={{ current_search }}&city={{ current_city }}&date_from={{ current_date_from }}&date_to={{ current_date_to }}" 
           class="btn btn-success btn-sm">
            <i class="bi bi-file-earmark-excel"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
        </a>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>–£—á–∞—Å—Ç–Ω–∏–∫</th>
                    <th>–®–∫–æ–ª–∞</th>
                    <th>–≠—Ç–∞–ø</th>
                    <th>–§–∞–π–ª—ã</th>
                    <th>–î–∞—Ç–∞</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for app in applications %}
                <tr class="clickable-row" data-href="/applications/{{ app.id }}" style="cursor: pointer;">
                    <td>#{{ app.id }}</td>
                    <td>
                        <strong>{{ app.user.full_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</strong>
                        {% if app.user.username %}
                        <br><small class="text-muted">@{{ app.user.username }}</small>
                        {% endif %}
                        <br><small class="text-muted">{{ app.user.grade }} –∫–ª–∞—Å—Å</small>
                    </td>
                    <td>
                        <small>{{ app.user.city }}<br>{{ app.user.school[:30] if app.user.school else '' }}{% if app.user.school and app.user.school|length > 30 %}...{% endif %}</small>
                    </td>
                    <td><span class="badge bg-primary">{{ app.nomination.name }}</span></td>
                    <td>
                        {% set photo_count = (app.photos | from_json | length) if app.photos else 0 %}
                        {% set file_count = (app.files | from_json | length) if app.files else 0 %}
                        <span class="badge bg-secondary">{{ photo_count + file_count }} üìé</span>
                    </td>
                    <td>{{ app.created_at|format_datetime }}</td>
                    <td class="text-end" onclick="event.stopPropagation();">
                        <form action="/applications/{{ app.id }}/delete" method="POST" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É #{{ app.id }}?');">
                            {{ csrf_token_input(request) | safe }}
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">–ù–µ—Ç –∑–∞—è–≤–æ–∫</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="card-footer">
        <nav>
            <ul class="pagination justify-content-center mb-0">
                {% set filter_params = "nomination_id=" ~ (current_nomination or '') ~ "&search=" ~ current_search ~ "&city=" ~ current_city ~ "&date_from=" ~ current_date_from ~ "&date_to=" ~ current_date_to %}
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page - 1 }}&{{ filter_params }}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="?page={{ p }}&{{ filter_params }}">{{ p }}</a>
                </li>
                {% endfor %}
                
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page + 1 }}&{{ filter_params }}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.clickable-row').forEach(function(row) {
        row.addEventListener('click', function() {
            window.location.href = this.dataset.href;
        });
    });
});
</script>
{% endblock %}
